<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>מעקב דוגמאות</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    select[multiple] { background-image: none !important; }
  </style>
</head>

<body class="min-h-screen bg-gray-50">

<div class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i data-lucide="package"></i> מעקב דוגמאות
    </h1>
    <div class="flex gap-3">
      <button id="exportJsonBtn" class="px-4 py-2 border rounded">ייצוא JSON</button>
      <button id="openContactsBtn" class="px-4 py-2 border rounded">
        אנשי קשר (<span id="contactsCount">0</span>)
      </button>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-4 py-6" id="mainContent"></div>

<!-- מודל דוגמה -->
<div id="sampleModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-md">
    <h3 id="sampleModalTitle" class="text-xl font-bold mb-4"></h3>
    <div id="sampleFormContent" class="space-y-4"></div>
  </div>
</div>

<script>
const statusOptions = [
  { value: 'received', label: 'התקבל' },
  { value: 'testing', label: 'בבדיקה' },
  { value: 'delivered', label: 'נמסר' }
];

let samples = [];
let contacts = [];
let currentSample = null;

function generateId(p){return p+'-'+Math.random().toString(36).slice(2,8)}
function nextSeq(){return samples.reduce((m,s)=>Math.max(m,s.seq||0),0)+1}

function renderMain(){
  document.getElementById('contactsCount').textContent = contacts.length;

  document.getElementById('mainContent').innerHTML = `
    <button onclick="openSampleModal()" class="mb-4 px-4 py-2 bg-black text-white rounded">
      דוגמה חדשה
    </button>

    <table class="w-full bg-white border rounded">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">שם</th>
          <th class="p-2">ספק</th>
          <th class="p-2">כמות</th>
          <th class="p-2">תאריך קבלה</th>
          <th class="p-2">סטטוס</th>
          <th class="p-2">פעולות</th>
        </tr>
      </thead>
      <tbody>
        ${samples.map(s=>`
          <tr class="border-t">
            <td class="p-2">${s.name}</td>
            <td class="p-2">${s.supplier}</td>
            <td class="p-2">${s.quantity}</td>
            <td class="p-2">${new Date(s.date).toLocaleDateString('he-IL')}</td>
            <td class="p-2">${statusOptions.find(o=>o.value===s.status)?.label}</td>
            <td class="p-2">
              <button onclick="openSampleModal('${s.id}')" class="text-blue-600">ערוך</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function openSampleModal(id=null){
  currentSample = id ? samples.find(s=>s.id===id) : null;
  document.getElementById('sampleModalTitle').textContent =
    currentSample ? 'עריכת דוגמה' : 'דוגמה חדשה';

  const d = currentSample?.date ? new Date(currentSample.date) : new Date();
  const dateVal = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

  document.getElementById('sampleFormContent').innerHTML = `
    <input id="sampleName" placeholder="שם דוגמה" class="w-full border p-2 rounded"
      value="${currentSample?.name||''}">
    <input id="sampleSupplier" placeholder="ספק" class="w-full border p-2 rounded"
      value="${currentSample?.supplier||''}">
    <input id="sampleQuantity" type="number" class="w-full border p-2 rounded"
      value="${currentSample?.quantity||0}">
    <input id="sampleDate" type="date" class="w-full border p-2 rounded"
      value="${dateVal}">
    <select id="sampleStatus" class="w-full border p-2 rounded">
      ${statusOptions.map(o=>`
        <option value="${o.value}" ${currentSample?.status===o.value?'selected':''}>
          ${o.label}
        </option>`).join('')}
    </select>

    <div class="flex justify-end gap-2 pt-2">
      <button onclick="closeModal()" class="px-4 py-2 border rounded">ביטול</button>
      <button onclick="saveSample()" class="px-4 py-2 bg-black text-white rounded">שמור</button>
    </div>
  `;

  document.getElementById('sampleModal').classList.remove('hidden');
  document.getElementById('sampleModal').classList.add('flex');
}

function closeModal(){
  document.getElementById('sampleModal').classList.add('hidden');
  document.getElementById('sampleModal').classList.remove('flex');
  currentSample = null;
}

function saveSample(){
  const name = sampleName.value.trim();
  if(!name) return alert('שם חובה');

  const dateIso = new Date(sampleDate.value+'T12:00:00').toISOString();

  if(currentSample){
    Object.assign(currentSample,{
      name,
      supplier: sampleSupplier.value,
      quantity:+sampleQuantity.value,
      status: sampleStatus.value,
      date: dateIso
    });
  } else {
    samples.push({
      id: generateId('SMPL'),
      seq: nextSeq(),
      name,
      supplier: sampleSupplier.value,
      quantity:+sampleQuantity.value,
      status: sampleStatus.value,
      date: dateIso
    });
  }

  closeModal();
  renderMain();
}

renderMain();
lucide.createIcons();
</script>
</body>
</html>
