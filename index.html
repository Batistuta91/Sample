<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××¢×§×‘ ×“×•×’×××•×ª</title>

  <!-- ××•× ×¢ 404 ×¢×œ favicon -->
  <link rel="icon" href="data:,">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>

<body class="min-h-screen bg-gray-50">

  <!-- ×›×•×ª×¨×ª ×¢×œ×™×•× ×” -->
  <div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center">
            <i data-lucide="package" class="w-6 h-6 text-white"></i>
          </div>
          <h1 class="text-2xl font-bold">××¢×§×‘ ×“×•×’×××•×ª</h1>
        </div>
        <div class="flex gap-3">
          <button id="exportJsonBtn" class="px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50 flex items-center gap-2">
            <i data-lucide="download" class="w-4 h-4"></i>
            ×™×™×¦× ×œ-JSON
          </button>
          <button id="openContactsBtn" class="px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50 flex items-center gap-2">
            <i data-lucide="users" class="w-4 h-4"></i>
            ×× ×©×™ ×§×©×¨ (<span id="contactsCount">0</span>)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
  <div class="max-w-7xl mx-auto px-4 py-8" id="mainContent"></div>

  <!-- ××•×“×œ ×“×•×’××” -->
  <div id="sampleModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold" id="sampleModalTitle">×“×•×’××” ×—×“×©×”</h3>
        <button id="closeSampleModal" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="space-y-4" id="sampleFormContent"></div>
    </div>
  </div>

  <!-- ××•×“×œ ×× ×©×™ ×§×©×¨ -->
  <div id="contactsModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl max-w-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold">× ×™×”×•×œ ×× ×©×™ ×§×©×¨</h3>
        <button id="closeContactsModal" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <button id="addContactBtn" class="mb-4 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 flex items-center gap-2">
        <i data-lucide="plus" class="w-4 h-4"></i>
        ×”×•×¡×£ ××™×© ×§×©×¨
      </button>

      <div id="contactsFormSection" class="bg-gray-50 rounded-lg p-4 mb-6 hidden"></div>
      <div id="contactsListSection" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIG - MyJSON (V2)
    // ==========================================
    // ××•×¤×¦×™×” 1: ×™×© ×œ×š Record ×§×™×™× -> ×”×“×‘×§ ×›××Ÿ
    // ××•×¤×¦×™×” 2: ××™×Ÿ ×œ×š Record -> ×”×©××¨ ×¨×™×§, ×•×ª×Ÿ COLLECTION_ID (×•×”××¢×¨×›×ª ×ª×™×¦×•×¨ ×œ×‘×“)
    const STORAGE_KEY_RECORD = "SAMPLES_RECORD_ID";

    const RECORD_ID_FALLBACK = ""; // ×× ×ª×¨×¦×” "×œ×§×‘×¢" ×™×“× ×™×ª, ×ª×“×‘×™×§ ×›××Ÿ
    const COLLECTION_ID = "";      // ××•××œ×¥ ×œ××œ× ×›×“×™ ×œ××¤×©×¨ ×™×¦×™×¨×” ××•×˜×•××˜×™×ª (UUID ×©×œ Collection)

    // ×× ×”×§×•×œ×§×©×Ÿ PRIVATE ×ª×¦×˜×¨×š Access Token ×××™×ª×™ ×©×œ ×”×§×•×œ×§×©×Ÿ.
    // ×–×” ×œ× recordId.
    const ACCESS_TOKEN = ""; // x-collection-access-token (×¨×§ ×× ×¦×¨×™×š)

    const API_BASE = "https://api.myjson.online/v2/records";

    function apiHeaders() {
      const h = { "Content-Type": "application/json" };
      if (ACCESS_TOKEN && ACCESS_TOKEN.trim()) {
        h["x-collection-access-token"] = ACCESS_TOKEN.trim();
      }
      return h;
    }

    function getRecordId() {
      return localStorage.getItem(STORAGE_KEY_RECORD) || RECORD_ID_FALLBACK || "";
    }

    function setRecordId(id) {
      if (id) localStorage.setItem(STORAGE_KEY_RECORD, id);
    }

    function recordUrl(id) {
      return `${API_BASE}/${id}`;
    }

    const statusOptions = [
      { value: 'received',  label: '×”×ª×§×‘×œ',  color: 'bg-blue-100 text-blue-800' },
      { value: 'testing',   label: '×‘×‘×“×™×§×”', color: 'bg-yellow-100 text-yellow-800' },
      { value: 'delivered', label: '× ××¡×¨',   color: 'bg-purple-100 text-purple-800' }
    ];

    let samples = [];
    let emailLog = [];
    let contacts = [];
    let currentSample = null;
    let editingContact = null;

    function generateId(prefix = 'SMPL') {
      return prefix + "-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).slice(2, 6).toUpperCase();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeData(dataObj) {
      const d = (dataObj && typeof dataObj === "object") ? dataObj : {};

      samples  = Array.isArray(d.samples)  ? d.samples  : [];
      contacts = Array.isArray(d.contacts) ? d.contacts : [];
      emailLog = Array.isArray(d.emailLog) ? d.emailLog : [];

      samples = samples.map(s => ({
        id: s.id || generateId("SMPL"),
        name: s.name || "",
        supplier: s.supplier || "",
        quantity: Number(s.quantity || 0),
        status: s.status || "received",
        notifyEmail: s.notifyEmail || "",
        assignedTo: s.assignedTo || null,
        date: s.date || new Date().toISOString()
      }));

      contacts = contacts.map(c => ({
        id: c.id || generateId("C"),
        name: c.name || "",
        email: c.email || ""
      }));
    }

    async function createRecordIfNeeded() {
      const existingId = getRecordId();
      if (existingId) return existingId;

      if (!COLLECTION_ID) {
        throw new Error("××™×Ÿ RECORD_ID ×•×’× ××™×Ÿ COLLECTION_ID ×›×“×™ ×œ×™×¦×•×¨ Record ×—×“×© ××•×˜×•××˜×™×ª.");
      }

      // ×œ×¤×™ ×”×“×•×§×•×× ×˜×¦×™×”: POST /v2/records ×¢× collectionId ×•-data :contentReference[oaicite:3]{index=3}
      const initData = {
        samples: [],
        contacts: [],
        emailLog: [],
        updateDate: new Date().toLocaleDateString("he-IL")
      };

      const res = await fetch(API_BASE, {
        method: "POST",
        headers: apiHeaders(),
        body: JSON.stringify({
          collectionId: COLLECTION_ID,
          data: initData,
          metadata: true
        })
      });

      if (!res.ok) throw new Error(`${res.status} - ${await res.text()}`);
      const created = await res.json();
      const newId = created?.id;
      if (!newId) throw new Error("× ×•×¦×¨ Record ××‘×œ ×œ× ×”×ª×§×‘×œ id ××”×©×¨×ª.");

      setRecordId(newId);
      return newId;
    }

    async function loadData() {
      try {
        let rid = getRecordId();
        if (!rid) {
          rid = await createRecordIfNeeded();
        }

        const res = await fetch(recordUrl(rid), { method: "GET", headers: apiHeaders() });
        if (res.status === 404) {
          // ×× ×”-id ×©××•×¨ ××‘×œ ×›×‘×¨ ×œ× ×§×™×™× -> × ×™×¦×•×¨ ××—×“×© (×× ×™×© COLLECTION_ID)
          localStorage.removeItem(STORAGE_KEY_RECORD);
          if (COLLECTION_ID) {
            const newId = await createRecordIfNeeded();
            const res2 = await fetch(recordUrl(newId), { method: "GET", headers: apiHeaders() });
            if (!res2.ok) throw new Error(`${res2.status} - ${await res2.text()}`);
            const result2 = await res2.json();
            normalizeData(result2.data);
          } else {
            throw new Error(`404 - Record ×œ× × ××¦×. ×”×“×‘×§ RECORD_ID ×ª×§×™×Ÿ ××• ××œ× COLLECTION_ID ×œ×™×¦×™×¨×” ××•×˜×•××˜×™×ª.`);
          }
        } else {
          if (!res.ok) throw new Error(`${res.status} - ${await res.text()}`);
          const result = await res.json();
          normalizeData(result.data);
        }
      } catch (err) {
        console.error("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×:", err);
        alert(
          "×©×’×™××” ×‘×˜×¢×™× ×ª MyJSON.\n\n" +
          "×‘×“×™×§×•×ª ××”×™×¨×•×ª:\n" +
          "1) RECORD_ID × ×›×•×Ÿ ×•×§×™×™×?\n" +
          "2) ×× ×§×•×œ×§×©×Ÿ PRIVATE: ×”×“×‘×§×ª ACCESS_TOKEN ×‘×›×•×ª×¨×ª x-collection-access-token?\n" +
          "3) ×× ××™×Ÿ Record: ××œ× COLLECTION_ID ×›×“×™ ×œ×™×¦×•×¨ ×—×“×©.\n\n" +
          "×¤×¨×˜×™× (Console): " + err.message
        );
      }

      renderMain();
    }

    async function saveData() {
      try {
        let rid = getRecordId();
        if (!rid) rid = await createRecordIfNeeded();

        const fullData = {
          samples,
          contacts,
          emailLog,
          updateDate: new Date().toLocaleDateString("he-IL")
        };

        // ×œ×¤×™ ×”×“×•×§×•×× ×˜×¦×™×”: PUT /v2/records/{recordId} ×¢× { data: {...} } :contentReference[oaicite:4]{index=4}
        const res = await fetch(recordUrl(rid), {
          method: "PUT",
          headers: apiHeaders(),
          body: JSON.stringify({ data: fullData, metadata: true })
        });

        if (!res.ok) throw new Error(`${res.status} - ${await res.text()}`);
        await res.json();
        console.log("âœ… × ×©××¨ ×‘×”×¦×œ×—×”!");
        return true;
      } catch (err) {
        console.error("âŒ ×©×’×™××” ×‘×©××™×¨×”:", err);
        alert("×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×.\n×‘×“×•×§ Console (F12).\n\n" + err.message);
        return false;
      }
    }

    function sendEmail(sample, oldStatus = null, newStatus) {
      const to = sample.notifyEmail || 'manager@company.com';
      const oldLabel = oldStatus ? (statusOptions.find(s => s.value === oldStatus)?.label || oldStatus) : '×—×“×©';
      const newLabel = statusOptions.find(s => s.value === newStatus)?.label || newStatus;

      const emailEntry = {
        to,
        subject: `×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×“×•×’××” - ${sample.name} (${oldLabel} â†’ ${newLabel})`,
        sampleId: sample.id,
        timestamp: new Date().toISOString()
      };

      emailLog.push(emailEntry);
      alert(`âœ‰ï¸ × ×¨×©× ×‘×™×•××Ÿ ××™×™×œ×™× (×¡×™××•×œ×¦×™×”)\n×œ: ${to}\n× ×•×©×: ${emailEntry.subject}`);
    }

    function exportToJson() {
      const data = { samples, contacts, emailLog };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'samples_data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ==========================================
    // UI - Render
    // ==========================================
    function renderMain() {
      document.getElementById('contactsCount').textContent = contacts.length;

      const stats = {
        total: samples.length,
        received: samples.filter(s => s.status === 'received').length,
        testing: samples.filter(s => s.status === 'testing').length,
        delivered: samples.filter(s => s.status === 'delivered').length
      };

      let filtered = samples;
      const statusFilter = document.getElementById('statusFilter')?.value || 'all';
      const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();

      if (statusFilter !== 'all') filtered = filtered.filter(s => s.status === statusFilter);
      if (searchTerm) {
        filtered = filtered.filter(s =>
          (s.name || '').toLowerCase().includes(searchTerm) ||
          (s.supplier || '').toLowerCase().includes(searchTerm) ||
          (s.id || '').toLowerCase().includes(searchTerm)
        );
      }

      const tableRows = filtered.length === 0
        ? `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">××™×Ÿ ×“×•×’×××•×ª ×œ×”×¦×’×”</td></tr>`
        : filtered.map(s => {
            const status = statusOptions.find(st => st.value === s.status) || statusOptions[0];
            const assigned = s.assignedTo ? (contacts.find(c => c.id === s.assignedTo)?.name || '×œ× ×™×“×•×¢') : '-';
            return `
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <div class="font-medium">${escapeHtml(s.name)}</div>
                  <div class="text-sm text-gray-500">${escapeHtml(s.id)}</div>
                </td>
                <td class="px-6 py-4">${escapeHtml(s.supplier)}</td>
                <td class="px-6 py-4 text-gray-600">#${Number(s.quantity || 0)}</td>
                <td class="px-6 py-4 text-gray-600">${new Date(s.date).toLocaleDateString('he-IL')}</td>
                <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-sm ${status.color}">${status.label}</span></td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    <div class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">ğŸ‘¤</div>
                    <span class="text-sm">${escapeHtml(assigned)}</span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <button onclick="openSampleModal('${s.id}')" class="text-blue-600 hover:text-blue-800">×¢×¨×•×š</button>
                    <button onclick="deleteSample('${s.id}')" class="text-red-600 hover:text-red-800">××—×§</button>
                  </div>
                </td>
              </tr>`;
          }).join('');

      const emailLogHtml = emailLog.length > 0 ? `
        <div class="mt-6 bg-white rounded-xl border p-6">
          <div class="flex items-center gap-2 mb-4">
            <i data-lucide="mail" class="w-5 h-5 text-gray-600"></i>
            <h3 class="text-lg font-bold">×™×•××Ÿ ××™×™×œ×™×</h3>
            <span class="text-sm text-gray-500">(${emailLog.length} × ×¨×©××•)</span>
          </div>
          <div class="space-y-2 max-h-60 overflow-y-auto">
            ${emailLog.slice(-8).reverse().map(e => `
              <div class="p-3 bg-gray-50 rounded-lg text-sm">
                <div class="flex justify-between mb-1 gap-3">
                  <span class="font-medium">${escapeHtml(e.subject || '')}</span>
                  <span class="text-gray-500 whitespace-nowrap">${new Date(e.timestamp).toLocaleString('he-IL')}</span>
                </div>
                <div class="text-gray-600">× ×©×œ×— ×œ: ${escapeHtml(e.to || '')}</div>
              </div>
            `).join('')}
          </div>
          <div class="text-xs text-gray-500 mt-3">* ×–×” ×™×•××Ÿ ×¡×™××•×œ×¦×™×”. ×©×œ×™×—×” ×××™×ª×™×ª ×“×•×¨×©×ª ×©×¨×ª/××•×˜×•××¦×™×”.</div>
        </div>` : '';

      document.getElementById('mainContent').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-3xl font-bold mb-2">× ×™×”×•×œ ×“×•×’×××•×ª</h2>
            <p class="text-gray-600">××¢×§×‘ ×•× ×™×”×•×œ ×“×•×’×××•×ª ×©×”×ª×§×‘×œ×• ×‘×—×‘×¨×”</p>
          </div>
          <button id="newSampleBtn" class="flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800">
            <i data-lucide="plus" class="w-5 h-5"></i>
            ×“×•×’××” ×—×“×©×”
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×¡×”"×›</span>
              <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center">
                <i data-lucide="package" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-3xl font-bold">${stats.total}</div>
          </div>

          <div class="bg-white p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×”×ª×§×‘×œ</span>
              <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                <i data-lucide="check-circle" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-3xl font-bold">${stats.received}</div>
          </div>

          <div class="bg-white p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×‘×‘×“×™×§×”</span>
              <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center">
                <i data-lucide="clock" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-3xl font-bold">${stats.testing}</div>
          </div>

          <div class="bg-white p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">× ××¡×¨</span>
              <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                <i data-lucide="send" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-3xl font-bold">${stats.delivered}</div>
          </div>
        </div>

        <div class="bg-white rounded-xl border mb-6 p-4">
          <div class="flex flex-col sm:flex-row gap-4">
            <select id="statusFilter" class="px-4 py-2 border rounded-lg">
              <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
              ${statusOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
            </select>

            <div class="flex-1 relative">
              <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
              <input id="searchInput" type="text" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ×¡×¤×§ ××• ID..." class="w-full pr-10 pl-4 py-2 border rounded-lg">
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl border overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×©× ×”×“×•×’××”</th>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×¡×¤×§</th>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×›××•×ª</th>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×ª××¨×™×š ×§×‘×œ×”</th>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×¡×˜×˜×•×¡</th>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">× ××¡×¨ ×œ</th>
                <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody class="divide-y">${tableRows}</tbody>
          </table>
        </div>

        ${emailLogHtml}
      `;

      lucide.createIcons();

      document.getElementById('statusFilter')?.addEventListener('change', renderMain);
      document.getElementById('searchInput')?.addEventListener('input', renderMain);
      document.getElementById('newSampleBtn')?.addEventListener('click', () => openSampleModal());
    }

    // ==========================================
    // Sample Modal
    // ==========================================
    function openSampleModal(id = null) {
      currentSample = id ? samples.find(s => s.id === id) : null;
      document.getElementById('sampleModalTitle').textContent = currentSample ? '×¢×¨×™×›×ª ×“×•×’××”' : '×“×•×’××” ×—×“×©×”';

      const contactOptions = contacts.map(c =>
        `<option value="${escapeHtml(c.email)}" ${currentSample?.notifyEmail === c.email ? 'selected' : ''}>${escapeHtml(c.name)} - ${escapeHtml(c.email)}</option>`
      ).join('');

      const assignedOptions = contacts.map(c =>
        `<option value="${escapeHtml(c.id)}" ${currentSample?.assignedTo === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>`
      ).join('');

      document.getElementById('sampleFormContent').innerHTML = `
        <div>
          <label class="block text-sm font-medium mb-2">×©× ×”×“×•×’××”</label>
          <input id="sampleName" type="text" value="${escapeHtml(currentSample?.name || '')}" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×¡×¤×§</label>
          <input id="sampleSupplier" type="text" value="${escapeHtml(currentSample?.supplier || '')}" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×›××•×ª</label>
          <input id="sampleQuantity" type="number" min="0" value="${Number(currentSample?.quantity || 0)}" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×¡×˜×˜×•×¡</label>
          <select id="sampleStatus" class="w-full px-4 py-2 border rounded-lg">
            ${statusOptions.map(o => `<option value="${o.value}" ${(currentSample?.status === o.value) || (!currentSample && o.value === 'received') ? 'selected' : ''}>${o.label}</option>`).join('')}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×”×•×“×¢×” ×œ××™×™×œ</label>
          <select id="sampleNotifyEmail" class="w-full px-4 py-2 border rounded-lg">
            <option value="">-- ×‘×—×¨ ××™×© ×§×©×¨ --</option>
            ${contactOptions}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">× ××¡×¨ ×œ</label>
          <select id="sampleAssigned" class="w-full px-4 py-2 border rounded-lg">
            <option value="">-- ×‘×—×¨ ××™×© ×§×©×¨ --</option>
            ${assignedOptions}
          </select>
        </div>

        <div class="mt-4 flex justify-end gap-3">
          <button onclick="closeModal('sampleModal')" class="px-4 py-2 border rounded-lg">×‘×˜×œ</button>
          <button onclick="saveSample()" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800">×©××•×¨</button>
        </div>
      `;

      document.getElementById('sampleModal').classList.remove('hidden');
      document.getElementById('sampleModal').classList.add('flex');

      lucide.createIcons();
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      document.getElementById(modalId).classList.remove('flex');
      currentSample = null;
      editingContact = null;
    }

    async function saveSample() {
      const name = document.getElementById('sampleName').value.trim();
      const supplier = document.getElementById('sampleSupplier').value.trim();
      const quantity = parseInt(document.getElementById('sampleQuantity').value, 10) || 0;
      const status = document.getElementById('sampleStatus').value;
      const notifyEmail = document.getElementById('sampleNotifyEmail').value;
      const assignedTo = document.getElementById('sampleAssigned').value || null;

      if (!name) return alert('×™×© ×œ×”×–×™×Ÿ ×©× ×“×•×’××”');

      const oldStatus = currentSample?.status || null;

      if (currentSample) {
        Object.assign(currentSample, { name, supplier, quantity, status, notifyEmail, assignedTo });
      } else {
        const id = generateId("SMPL");
        samples.push({ id, name, supplier, quantity, status, notifyEmail, assignedTo, date: new Date().toISOString() });
      }

      const saved = await saveData();

      if (saved && status !== oldStatus) {
        const sampleRef = currentSample || samples[samples.length - 1];
        sendEmail(sampleRef, oldStatus, status);
        await saveData();
      }

      closeModal('sampleModal');
      renderMain();
    }

    async function deleteSample(id) {
      if (!confirm("×œ××—×•×§ ×“×•×’××” ×–×•?")) return;
      samples = samples.filter(s => s.id !== id);
      await saveData();
      renderMain();
    }

    // ==========================================
    // Contacts Modal
    // ==========================================
    function openContactsModal() {
      renderContacts();
      document.getElementById('contactsModal').classList.remove('hidden');
      document.getElementById('contactsModal').classList.add('flex');
      lucide.createIcons();
    }

    function renderContacts() {
      document.getElementById('contactsCount').textContent = contacts.length;

      const section = document.getElementById('contactsListSection');
      section.innerHTML = contacts.length === 0
        ? `<div class="text-gray-500 text-center py-4">××™×Ÿ ×× ×©×™ ×§×©×¨. ×œ×—×¥ ×¢×œ "×”×•×¡×£ ××™×© ×§×©×¨" ×›×“×™ ×œ×”×ª×—×™×œ.</div>`
        : contacts.map(c => `
          <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
            <div>
              <span class="font-medium">${escapeHtml(c.name)}</span>
              <span class="text-gray-400">â€¢</span>
              <span class="text-gray-600">${escapeHtml(c.email)}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="editContact('${escapeHtml(c.id)}')" class="text-blue-600 hover:text-blue-800 px-3 py-1">×¢×¨×•×š</button>
              <button onclick="deleteContact('${escapeHtml(c.id)}')" class="text-red-600 hover:text-red-800 px-3 py-1">××—×§</button>
            </div>
          </div>
        `).join('');

      document.getElementById('addContactBtn').onclick = () => showContactForm();
    }

    function showContactForm(contactId = null) {
      editingContact = contactId ? contacts.find(c => c.id === contactId) : null;

      const section = document.getElementById('contactsFormSection');
      section.classList.remove('hidden');
      section.innerHTML = `
        <h4 class="font-bold mb-3">${editingContact ? '×¢×¨×™×›×ª ××™×© ×§×©×¨' : '××™×© ×§×©×¨ ×—×“×©'}</h4>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">×©× ××œ×</label>
            <input id="contactName" type="text" placeholder="×©× ×¤×¨×˜×™ ×•××©×¤×—×”" value="${escapeHtml(editingContact?.name || '')}" class="w-full px-4 py-2 border rounded-lg">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">×›×ª×•×‘×ª ××™×™×œ</label>
            <input id="contactEmail" type="email" placeholder="example@company.com" value="${escapeHtml(editingContact?.email || '')}" class="w-full px-4 py-2 border rounded-lg">
          </div>
        </div>

        <div class="mt-4 flex justify-end gap-3">
          <button onclick="clearContactForm()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">×‘×˜×œ</button>
          <button onclick="saveContact()" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800">×©××•×¨</button>
        </div>
      `;
    }

    function editContact(id) { showContactForm(id); }

    function clearContactForm() {
      editingContact = null;
      document.getElementById('contactsFormSection').classList.add('hidden');
      document.getElementById('contactsFormSection').innerHTML = '';
    }

    async function saveContact() {
      const name = document.getElementById('contactName')?.value.trim();
      const email = document.getElementById('contactEmail')?.value.trim();

      if (!name || !email) return alert('×™×© ×œ××œ× ×©× ×•××™×™×œ');
      if (!email.includes('@')) return alert('×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”');

      const emailLower = email.toLowerCase();
      const duplicate = contacts.find(c => c.email?.toLowerCase() === emailLower && (!editingContact || c.id !== editingContact.id));
      if (duplicate) return alert('×›×‘×¨ ×§×™×™× ××™×© ×§×©×¨ ×¢× ××™×™×œ ×–×”.');

      if (editingContact) Object.assign(editingContact, { name, email });
      else contacts.push({ id: generateId('C'), name, email });

      const saved = await saveData();
      if (saved) {
        clearContactForm();
        renderContacts();
        renderMain();
        alert('âœ… ××™×© ×”×§×©×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
      }
    }

    async function deleteContact(id) {
      if (!confirm("×œ××—×•×§ ××™×© ×§×©×¨ ×–×”?")) return;

      contacts = contacts.filter(c => c.id !== id);
      samples = samples.map(s => (s.assignedTo === id ? { ...s, assignedTo: null } : s));

      const saved = await saveData();
      if (saved) {
        renderContacts();
        renderMain();
        alert('âœ… ××™×© ×”×§×©×¨ × ××—×§ ×‘×”×¦×œ×—×”!');
      }
    }

    // ==========================================
    // Events + init
    // ==========================================
    document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
    document.getElementById('openContactsBtn').addEventListener('click', openContactsModal);
    document.getElementById('closeContactsModal').addEventListener('click', () => closeModal('contactsModal'));
    document.getElementById('closeSampleModal').addEventListener('click', () => closeModal('sampleModal'));

    document.getElementById('sampleModal').addEventListener('click', (e) => {
      if (e.target.id === "sampleModal") closeModal("sampleModal");
    });
    document.getElementById('contactsModal').addEventListener('click', (e) => {
      if (e.target.id === "contactsModal") closeModal("contactsModal");
    });

    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();
      console.log("ğŸš€ ×××ª×—×œ ××ª ×”××¢×¨×›×ª...");
      loadData();
    });

    window.openSampleModal = openSampleModal;
    window.deleteSample = deleteSample;
    window.editContact = editContact;
    window.deleteContact = deleteContact;
    window.saveSample = saveSample;
    window.closeModal = closeModal;
    window.showContactForm = showContactForm;
    window.clearContactForm = clearContactForm;
    window.saveContact = saveContact;
  </script>
</body>
</html>
