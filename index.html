<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××¢×§×‘ ×“×•×’×××•×ª</title>

  <!-- ××•× ×¢ 404 ×¢×œ favicon -->
  <link rel="icon" href="data:,">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }

    /* ×œ×›×¤×ª×•×¨×™ multi-select ×‘×œ×™ ××™×™×§×•×Ÿ ×“×™×¤×•×œ×˜×™ */
    select[multiple] { background-image: none !important; }

    /* âœ… ×× ×™×¢×ª "×‘×¨×™×—×”" ××”××¡×š ×•×”×•×¡×¤×ª ×’×œ×™×œ×” ×¨×§ ×œ××–×•×¨×™ ×ª×•×›×Ÿ (×œ× ×œ×›×œ ×”×“×£) */
    html, body { height: 100%; overflow-x: hidden; }

    /* ×˜×‘×œ××•×ª/×ª×•×›×Ÿ ×¨×—×‘ â€“ ×™×ª×’×œ×œ×• ××•×¤×§×™×ª ×‘×ª×•×š ×”×§×•×¤×¡×” */
    .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-scroll table { min-width: 980px; } /* ×©×•××¨ ×¢×œ ×¢××•×“×•×ª ×§×¨×™××•×ª ×‘××—×©×‘ */

    /* ××•×“×œ×™× â€“ ×’×œ×™×œ×” ×¤× ×™××™×ª */
    .modal-card { max-height: 90vh; overflow: auto; }

    /* ××•× ×¢ "×”×ª×¤×•×¦×¦×•×ª" ×˜×§×¡×˜ ××¨×•×š (××™×™×œ/×¡×¤×§/×©×) */
    .break-anywhere { overflow-wrap: anywhere; word-break: break-word; }

    /* âœ… ×©×“×” ×—×™×¤×•×© â€“ ×˜×§×¡×˜ × ×¨××” ×ª××™×“ */
    #searchInput {
      color: #111827 !important;
      background-color: #ffffff !important;
      caret-color: #111827 !important;
      -webkit-text-fill-color: #111827 !important;
      filter: none !important;
      -webkit-filter: none !important;
      text-shadow: none !important;
      -webkit-appearance: none !important;
      appearance: none !important;
    }
    #searchInput::placeholder {
      color: #9ca3af !important;
      -webkit-text-fill-color: #9ca3af !important;
      opacity: 1 !important;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50">

  <!-- ×›×•×ª×¨×ª ×¢×œ×™×•× ×” -->
  <div class="bg-white border-b sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center shrink-0">
            <i data-lucide="package" class="w-6 h-6 text-white"></i>
          </div>
          <div class="min-w-0">
            <h1 class="text-2xl font-bold truncate">××¢×§×‘ ×“×•×’×××•×ª</h1>

            <!-- Record ID ×¤× ×™××™ - ××•×¡×ª×¨ (×œ× ××•×¦×’ ×œ××©×ª××©) -->
            <div class="hidden" aria-hidden="true">
              Record: <span id="ridBadge" class="font-mono">â€”</span>
              <button id="copyRidBtn" class="ml-2 text-blue-600 hover:underline hidden">×”×¢×ª×§</button>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <button id="exportJsonBtn" class="px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50 flex items-center gap-2">
            <i data-lucide="download" class="w-4 h-4"></i>
            ×™×™×¦× ×œ-JSON
          </button>
          <button id="openContactsBtn" class="px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50 flex items-center gap-2">
            <i data-lucide="users" class="w-4 h-4"></i>
            ×× ×©×™ ×§×©×¨ (<span id="contactsCount">0</span>)
          </button>

          <!-- âœ… ××™× ×“×™×§×¦×™×” ××•×˜×•××˜×™×ª ××•×‘×™×™×œ/××—×©×‘ -->
          <span id="devicePill" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white text-sm text-gray-600">
            <i data-lucide="smartphone" class="w-4 h-4"></i>
            <span id="deviceLabel">××•×‘×™×™×œ</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- ×”×•×“×¢×ª ××¦×‘ -->
  <div class="max-w-7xl mx-auto px-4 pt-4">
    <div id="statusBanner" class="hidden rounded-lg border bg-white p-3 text-sm"></div>
  </div>

  <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
  <div class="max-w-7xl mx-auto px-4 py-6 sm:py-8" id="mainContent"></div>

  <!-- ××•×“×œ ×“×•×’××” -->
  <div id="sampleModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl max-w-md w-full p-6 modal-card">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold" id="sampleModalTitle">×“×•×’××” ×—×“×©×”</h3>
        <button id="closeSampleModal" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="space-y-4" id="sampleFormContent"></div>
    </div>
  </div>

  <!-- ××•×“×œ ×× ×©×™ ×§×©×¨ -->
  <div id="contactsModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl max-w-3xl w-full p-6 modal-card">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold">× ×™×”×•×œ ×× ×©×™ ×§×©×¨</h3>
        <button id="closeContactsModal" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <button id="addContactBtn" class="mb-4 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 flex items-center gap-2">
        <i data-lucide="plus" class="w-4 h-4"></i>
        ×”×•×¡×£ ××™×© ×§×©×¨
      </button>

      <div id="contactsFormSection" class="bg-gray-50 rounded-lg p-4 mb-6 hidden"></div>
      <div id="contactsListSection" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIG - MyJSON (V2) - ×‘×œ×™ LocalStorage
    // ==========================================
    const COLLECTION_ID = "067b6138-3f46-42a8-971a-9d62ebab009f"; // ×©×œ×š
    const ACCESS_TOKEN = ""; // Public -> ×¨×™×§
    const API_BASE = "https://api.myjson.online/v2/records";

    function apiHeaders() {
      const h = { "Content-Type": "application/json" };
      if (ACCESS_TOKEN && ACCESS_TOKEN.trim()) {
        h["x-collection-access-token"] = ACCESS_TOKEN.trim();
      }
      return h;
    }

    function recordUrl(id) {
      return `${API_BASE}/${id}`;
    }

    // ==========================================
    // Record ID ×“×¨×š URL (×œ× ×œ×•×§××œ×™)
    // ==========================================
    function getRidFromUrl() {
      const u = new URL(window.location.href);
      const rid = u.searchParams.get("rid");
      return rid && rid.trim() ? rid.trim() : "";
    }

    function setRidInUrl(rid) {
      const u = new URL(window.location.href);
      u.searchParams.set("rid", rid);
      window.history.replaceState({}, "", u.toString());
      updateRidUI(rid);
    }

    function updateRidUI(rid) {
      const badge = document.getElementById("ridBadge");
      const copyBtn = document.getElementById("copyRidBtn");
      if (!badge || !copyBtn) return;
      badge.textContent = rid ? rid : "â€”";
      if (rid) copyBtn.classList.remove("hidden");
      else copyBtn.classList.add("hidden");
    }

    function showBanner(html, type = "info") {
      const el = document.getElementById("statusBanner");
      el.classList.remove("hidden");
      const base = "rounded-lg border p-3 text-sm";
      const styles = {
        info: "bg-white border-gray-200 text-gray-800",
        ok: "bg-green-50 border-green-200 text-green-900",
        warn: "bg-yellow-50 border-yellow-200 text-yellow-900",
        err: "bg-red-50 border-red-200 text-red-900"
      };
      el.className = `${base} ${styles[type] || styles.info}`;
      el.innerHTML = html;
    }

    // ==========================================
    // âœ… ×–×™×”×•×™ ××•×˜×•××˜×™: ××•×‘×™×™×œ/××—×©×‘ + ×¢×“×›×•×Ÿ ××™× ×“×™×§×¦×™×”
    // ==========================================
    function isMobileNow() {
      const coarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
      const narrow = window.innerWidth < 640; // sm
      return coarse || narrow;
    }

    function updateDevicePill() {
      const pill = document.getElementById("devicePill");
      const label = document.getElementById("deviceLabel");
      if (!pill || !label) return;

      const mobile = isMobileNow();
      label.textContent = mobile ? "××•×‘×™×™×œ" : "××—×©×‘";
      pill.innerHTML = mobile
        ? `<i data-lucide="smartphone" class="w-4 h-4"></i><span id="deviceLabel">××•×‘×™×™×œ</span>`
        : `<i data-lucide="monitor" class="w-4 h-4"></i><span id="deviceLabel">××—×©×‘</span>`;
      lucide.createIcons();
    }

    // ==========================================
    // Data model
    // ==========================================
    const statusOptions = [
      { value: 'ordered',   label: '×”×•×–××Ÿ',  color: 'bg-gray-100 text-gray-800' },
      { value: 'received',  label: '×”×ª×§×‘×œ',  color: 'bg-blue-100 text-blue-800' },
      { value: 'testing',   label: '×‘×‘×“×™×§×”', color: 'bg-yellow-100 text-yellow-800' },
      { value: 'delivered', label: '× ××¡×¨',   color: 'bg-purple-100 text-purple-800' }
    ];

    let samples = [];
    let emailLog = [];
    let contacts = [];
    let currentSample = null;
    let editingContact = null;

    // âœ… ×‘×—×™×¨×” ××¨×•×‘×” ×‘×˜×‘×œ×”
    let selectedSampleIds = new Set();

    // âœ… ××¦×‘ UI (×›×“×™ ×©×”×—×™×¤×•×©/×¤×™×œ×˜×¨ ×œ× ×™×™×¢×œ××• ×‘×¨×™× ×“×•×¨ ××—×“×©)
    let uiState = {
      search: "",
      status: "all"
    };

    function generateId(prefix = 'SMPL') {
      return prefix + "-" + Date.now().toString(36).toUpperCase() + "-" + Math.random().toString(36).slice(2, 6).toUpperCase();
    }

    function nextSampleSeq() {
      const maxSeq = samples.reduce((m, s) => Math.max(m, Number(s.seq || 0)), 0);
      return maxSeq + 1;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeData(dataObj) {
      const d = (dataObj && typeof dataObj === "object") ? dataObj : {};

      samples  = Array.isArray(d.samples)  ? d.samples  : [];
      contacts = Array.isArray(d.contacts) ? d.contacts : [];
      emailLog = Array.isArray(d.emailLog) ? d.emailLog : [];

      samples = samples.map(s => ({
        id: s.id || generateId("SMPL"),
        seq: Number(s.seq || 0),
        name: s.name || "",
        supplier: s.supplier || "",
        quantity: Number(s.quantity || 0),
        status: s.status || "ordered",
        notifyEmail: s.notifyEmail || "",
        ccEmails: Array.isArray(s.ccEmails) ? s.ccEmails : [],
        assignedTo: s.assignedTo || null,
        date: s.date || new Date().toISOString()
      }));

      const needsSeq = samples.some(s => !s.seq);
      if (needsSeq) {
        const sorted = [...samples].sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
        let i = 1;
        for (const s of sorted) {
          if (!s.seq) s.seq = i;
          i = Math.max(i, s.seq + 1);
        }
        const mapById = new Map(sorted.map(s => [s.id, s]));
        samples = samples.map(s => mapById.get(s.id) || s);
      }

      contacts = contacts.map(c => ({
        id: c.id || generateId("C"),
        name: c.name || "",
        email: c.email || ""
      }));
    }

    // ==========================================
    // MyJSON - Create / Load / Save
    // ==========================================
    async function createRecord() {
      const initData = {
        samples: [],
        contacts: [],
        emailLog: [],
        updateDate: new Date().toLocaleDateString("he-IL")
      };

      const res = await fetch(API_BASE, {
        method: "POST",
        headers: apiHeaders(),
        body: JSON.stringify({
          collectionId: COLLECTION_ID,
          data: initData,
          metadata: true
        })
      });

      if (!res.ok) throw new Error(`${res.status} - ${await res.text()}`);
      const created = await res.json();
      const newId = created?.id;
      if (!newId) throw new Error("× ×•×¦×¨ Record ××‘×œ ×œ× ×”×ª×§×‘×œ id ××”×©×¨×ª.");
      return newId;
    }

    async function ensureRecordId() {
      let rid = getRidFromUrl();
      if (rid) {
        updateRidUI(rid);
        return rid;
      }

      showBanner(`×™×•×¦×¨ ×××’×¨ × ×ª×•× ×™× ×—×“×© ×•××—×‘×¨ ××ª ×”××¢×¨×›×ª...`, "info");
      const newId = await createRecord();
      setRidInUrl(newId);
      showBanner(`âœ… × ×•×¦×¨ ×××’×¨ × ×ª×•× ×™× ×—×“×© ×•×”××¢×¨×›×ª ××—×•×‘×¨×ª ××œ×™×•.`, "ok");
      return newId;
    }

    async function loadData() {
      try {
        const rid = await ensureRecordId();
        const res = await fetch(recordUrl(rid), { method: "GET", headers: apiHeaders() });
        if (!res.ok) throw new Error(`${res.status} - ${await res.text()}`);

        const result = await res.json();
        normalizeData(result.data);

        if (samples.some(s => s.seq)) {
          await saveData();
        }

      } catch (err) {
        console.error("âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×:", err);
        showBanner(
          `âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×-MyJSON.<br><br>
           <div class="font-mono text-xs whitespace-pre-wrap">${escapeHtml(err.message)}</div>`,
          "err"
        );
      }

      renderMain();
    }

    async function saveData() {
      try {
        const rid = await ensureRecordId();

        const fullData = {
          samples,
          contacts,
          emailLog,
          updateDate: new Date().toLocaleDateString("he-IL")
        };

        const res = await fetch(recordUrl(rid), {
          method: "PUT",
          headers: apiHeaders(),
          body: JSON.stringify({ data: fullData, metadata: true })
        });

        if (!res.ok) throw new Error(`${res.status} - ${await res.text()}`);
        await res.json();
        return true;
      } catch (err) {
        console.error("âŒ ×©×’×™××” ×‘×©××™×¨×”:", err);
        showBanner(
          `âŒ ×©×’×™××” ×‘×©××™×¨×” ×œ-MyJSON.<br><br>
           <div class="font-mono text-xs whitespace-pre-wrap">${escapeHtml(err.message)}</div>`,
          "err"
        );
        return false;
      }
    }

    // ==========================================
    // Email helpers
    // ==========================================
    function rtl(line) { return '\u202B' + line; }

    function buildEmailBody(sample, oldStatus, newStatus) {
      const assignedName = sample.assignedTo
        ? (contacts.find(c => c.id === sample.assignedTo)?.name || 'â€”')
        : 'â€”';

      let intro = '';
      if (newStatus === 'received') intro = '×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ ×›×™ ×“×•×’××” ×”×ª×§×‘×œ×” ×‘××—×¡×Ÿ.';
      else if (newStatus === 'testing') intro = '×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ×’×‘×™ ×“×•×’××” ×©× ××¦××ª ×‘×‘×“×™×§×” ×‘××—×¡×Ÿ.';
      else if (newStatus === 'delivered') intro = '×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ ×›×™ ×”×“×•×’××” × ××¡×¨×” ××”××—×¡×Ÿ.';
      else intro = '×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ×’×‘×™ ×“×•×’××” ×‘××—×¡×Ÿ.';

      const lines = [
        rtl('×©×œ×•×,'),
        '',
        rtl(intro),
        '',
        rtl('×¤×¨×˜×™ ×”×“×•×’××”:'),
        rtl(`â€¢ ×“×•×’××”: ${sample.name}`),
        rtl(`â€¢ ×¡×¤×§: ${sample.supplier || ''}`),
        rtl(`â€¢ ×›××•×ª: ${Number(sample.quantity || 0)}`),
        rtl(`â€¢ ×ª××¨×™×š: ${new Date(sample.date).toLocaleDateString('he-IL')}`)
      ];

      if (newStatus === 'delivered') {
        lines.push(rtl(`â€¢ × ××¡×¨ ×œ: ${assignedName}`));
      }

      lines.push('', rtl('×‘×‘×¨×›×”,'), rtl('××—×¡×Ÿ CIDEV'));
      return lines.join('\n');
    }

    function buildBulkDeliveredEmailBody({ samplesList, assignedToId }) {
      const assignedName = assignedToId
        ? (contacts.find(c => c.id === assignedToId)?.name || 'â€”')
        : 'â€”';

      const lines = [
        rtl('×©×œ×•×,'),
        '',
        rtl('×¨×¦×™×ª×™ ×œ×¢×“×›×Ÿ ×›×™ ××¡×¤×¨ ×“×•×’×××•×ª × ××¡×¨×• ××”××—×¡×Ÿ.'),
        '',
        rtl(`× ××¡×¨ ×œ: ${assignedName}`),
        '',
        rtl('×¨×©×™××ª ×“×•×’×××•×ª:')
      ];

      for (const s of samplesList) {
        const dateLabel = s.date ? new Date(s.date).toLocaleDateString('he-IL') : '';
        lines.push(rtl(`â€¢ #${Number(s.seq || 0)} | ${s.name} | ×¡×¤×§: ${s.supplier || ''} | ×›××•×ª: ${Number(s.quantity || 0)} | ×ª××¨×™×š: ${dateLabel}`));
      }

      lines.push('', rtl('×‘×‘×¨×›×”,'), rtl('××—×¡×Ÿ CIDEV'));
      return lines.join('\n');
    }

    function openEmailDraft({ toList, subject, body }) {
      const to = (Array.isArray(toList) ? toList : [])
        .map(x => (x || "").trim())
        .filter(Boolean)
        .join(";");

      const url =
        `mailto:${encodeURIComponent(to)}` +
        `?subject=${encodeURIComponent(subject || '')}` +
        `&body=${encodeURIComponent(body || '')}`;

      window.location.href = url;
    }

    function sendEmail(sample, oldStatus = null, newStatus) {
      const mainTo = (sample.notifyEmail || '').trim();
      if (!mainTo) {
        alert('×œ× × ×‘×—×¨ × ××¢×Ÿ ×œ××™×™×œ (×”×•×“×¢×” ×œ××™×™×œ). ×‘×—×¨ ××™×© ×§×©×¨ ×•××– ×©××•×¨ ×©×•×‘.');
        return;
      }

      const extra = Array.isArray(sample.ccEmails) ? sample.ccEmails : [];
      const toList = Array.from(new Set([mainTo, ...extra].map(x => (x || '').trim()).filter(Boolean)));

      const oldLabel = oldStatus
        ? (statusOptions.find(s => s.value === oldStatus)?.label || oldStatus)
        : '×—×“×©';
      const newLabel = statusOptions.find(s => s.value === newStatus)?.label || newStatus;

      const subject = `×¢×“×›×•×Ÿ ×“×•×’××” - ${sample.name} (${oldLabel} â†’ ${newLabel})`;
      const body = buildEmailBody(sample, oldStatus, newStatus);

      emailLog.push({
        to: mainTo,
        extra,
        subject,
        sampleId: sample.id,
        timestamp: new Date().toISOString()
      });

      openEmailDraft({ toList, subject, body });
    }

    function sendBulkDeliveredEmail({ toMain, ccEmails, assignedToId, samplesList }) {
      const mainTo = (toMain || '').trim();
      if (!mainTo) {
        alert('×œ× × ×‘×—×¨ × ××¢×Ÿ ×œ××™×™×œ (× ××¢×Ÿ ×¨××©×™).');
        return;
      }

      const extra = Array.isArray(ccEmails) ? ccEmails : [];
      const toList = Array.from(new Set([mainTo, ...extra].map(x => (x || '').trim()).filter(Boolean)));

      const subject = `×¢×“×›×•×Ÿ ×“×•×’×××•×ª - × ××¡×¨×• (${samplesList.length})`;
      const body = buildBulkDeliveredEmailBody({ samplesList, assignedToId });

      emailLog.push({
        to: mainTo,
        extra,
        subject,
        sampleId: `BULK-${Date.now()}`,
        timestamp: new Date().toISOString()
      });

      openEmailDraft({ toList, subject, body });
    }

    async function deleteEmailLogItem(idxFromEnd) {
      const realIndex = emailLog.length - 1 - idxFromEnd;
      if (realIndex < 0 || realIndex >= emailLog.length) return;
      if (!confirm("×œ××—×•×§ ×¨×©×•××ª ××™×™×œ ×–×• ××”×™×•××Ÿ?")) return;
      emailLog.splice(realIndex, 1);
      await saveData();
      renderMain();
    }

    async function clearEmailLog() {
      if (!confirm("×œ× ×§×•×ª ××ª ×›×œ ×™×•××Ÿ ×”××™×™×œ×™×?")) return;
      emailLog = [];
      await saveData();
      renderMain();
    }

    // ==========================================
    // Export
    // ==========================================
    function exportToJson() {
      const data = { samples, contacts, emailLog };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'samples_data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ==========================================
    // Bulk actions - update + email
    // ==========================================
    function getUniqueEmailsFromSelected(samplesList) {
      const emails = [];
      for (const s of samplesList) {
        const main = (s.notifyEmail || '').trim();
        if (main) emails.push(main);
        const extra = Array.isArray(s.ccEmails) ? s.ccEmails : [];
        for (const e of extra) if ((e || '').trim()) emails.push((e || '').trim());
      }
      const seen = new Set();
      const out = [];
      for (const e of emails) {
        const k = String(e).toLowerCase();
        if (seen.has(k)) continue;
        seen.add(k);
        out.push(e);
      }
      return out;
    }

    async function bulkDeliverAndEmail({ ids, assignedToId, emailMain, emailCcList }) {
      if (!ids || !ids.length) return;

      const selected = ids
        .map(id => samples.find(s => s.id === id))
        .filter(Boolean);

      if (!selected.length) return;

      if (!assignedToId) return alert('×‘×—×¨ ×œ××™ × ××¡×¨');

      if (!confirm(`×œ×¡××Ÿ ${selected.length} ×“×•×’×××•×ª ×›"× ××¡×¨" ×•×œ×¤×ª×•×— ××™×™×œ ××¨×•×›×–?`)) return;

      for (const s of selected) {
        s.status = 'delivered';
        s.assignedTo = assignedToId;
      }

      const saved = await saveData();
      if (!saved) return;

      sendBulkDeliveredEmail({
        toMain: emailMain,
        ccEmails: emailCcList,
        assignedToId,
        samplesList: selected
      });

      await saveData();

      selectedSampleIds.clear();
      renderMain();
    }

    // ==========================================
    // UI - Render
    // ==========================================
    function renderMain() {
      document.getElementById('contactsCount').textContent = contacts.length;

      const stats = {
        total: samples.length,
        ordered: samples.filter(s => s.status === 'ordered').length,
        received: samples.filter(s => s.status === 'received').length,
        testing: samples.filter(s => s.status === 'testing').length,
        delivered: samples.filter(s => s.status === 'delivered').length
      };

      // âœ… ××©×ª××©×™× ×‘-state ×‘××§×•× ×œ×§×¨×•× ××”-DOM (×›×™ ×”-DOM × ×‘× ×” ××—×“×©)
      let filtered = samples;
      const statusFilter = uiState.status || 'all';
      const searchTermRaw = uiState.search || '';
      const searchTerm = searchTermRaw.trim().toLowerCase();

      if (statusFilter !== 'all') filtered = filtered.filter(s => s.status === statusFilter);

      if (searchTerm) {
        filtered = filtered.filter(s => {
          const statusLabel =
            (statusOptions.find(st => st.value === s.status)?.label) || "";

          const assignedName =
            s.assignedTo
              ? (contacts.find(c => c.id === s.assignedTo)?.name || "")
              : "";

          const dateLabel = s.date ? new Date(s.date).toLocaleDateString('he-IL') : "";

          const haystack = [
            s.seq,
            "#" + (s.seq ?? ""),
            s.name,
            s.supplier,
            s.quantity,
            dateLabel,
            statusLabel,
            assignedName,
            s.notifyEmail,
            ...(Array.isArray(s.ccEmails) ? s.ccEmails : [])
          ]
            .filter(v => v !== null && v !== undefined)
            .join(" ")
            .toLowerCase();

          return haystack.includes(searchTerm);
        });
      }

      const selectedIdsVisible = filtered.map(s => s.id);
      const selectedCount = Array.from(selectedSampleIds).filter(id => selectedIdsVisible.includes(id)).length || selectedSampleIds.size;

      const selectedSamplesForDefaults = Array.from(selectedSampleIds)
        .map(id => samples.find(s => s.id === id))
        .filter(Boolean);

      const suggestedEmails = getUniqueEmailsFromSelected(selectedSamplesForDefaults);
      const suggestedMain = suggestedEmails[0] || "";
      const suggestedCc = suggestedEmails.slice(1);

      const contactEmailOptions = contacts.map(c => {
        const email = (c.email || '').trim();
        return `<option value="${escapeHtml(email)}">${escapeHtml(c.name)} - ${escapeHtml(email)}</option>`;
      }).join('');

      const suggestedMainOptionHtml = suggestedMain
        ? `<option value="${escapeHtml(suggestedMain)}" selected>××•×¦×¢: ${escapeHtml(suggestedMain)}</option>`
        : '';

      const suggestedCcSet = new Set(suggestedCc.map(e => String(e).toLowerCase()));
      const ccOptionsFromContacts = contacts.map(c => {
        const email = (c.email || '').trim();
        const sel = suggestedCcSet.has(String(email).toLowerCase()) ? 'selected' : '';
        return `<option value="${escapeHtml(email)}" ${sel}>${escapeHtml(c.name)} - ${escapeHtml(email)}</option>`;
      }).join('');

      const assignedOptions = contacts.map(c =>
        `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`
      ).join('');

      const bulkBar = selectedSampleIds.size ? `
        <div class="bg-white rounded-xl border mb-4 p-4">
          <div class="flex flex-col gap-3">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div class="text-sm text-gray-700">
                × ×‘×—×¨×• <b>${selectedSampleIds.size}</b> ×“×•×’×××•×ª
              </div>
              <button id="bulkClearBtn" class="px-3 py-2 border rounded-lg hover:bg-gray-50 w-full sm:w-auto">
                × ×§×” ×‘×—×™×¨×”
              </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-2">× ××¡×¨ ×œ</label>
                <select id="bulkAssignedTo" class="px-4 py-2 border rounded-lg w-full">
                  <option value="">×‘×—×¨ ××™×© ×§×©×¨</option>
                  ${assignedOptions}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">××™×™×œ ××¨×•×›×– - × ××¢×Ÿ ×¨××©×™</label>
                <select id="bulkEmailMain" class="px-4 py-2 border rounded-lg w-full">
                  <option value="">-- ×‘×—×¨ ××™×© ×§×©×¨ --</option>
                  ${suggestedMainOptionHtml}
                  ${contactEmailOptions}
                </select>
                <div class="text-xs text-gray-500 mt-1">××¤×©×¨ ×œ×‘×—×•×¨ ×œ××™ ×œ×©×œ×•×— (×œ× ×—×™×™×‘ ×œ×”×™×•×ª ××—×“ ××”×“×•×’×××•×ª ×©× ×‘×—×¨×•).</div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">××™×™×œ ××¨×•×›×– - × ××¢× ×™× × ×•×¡×¤×™×</label>
                <select id="bulkEmailCc" multiple class="px-4 py-2 border rounded-lg w-full h-24">
                  ${ccOptionsFromContacts}
                </select>
                <div class="text-xs text-gray-500 mt-1">××¤×©×¨ ×œ×‘×—×•×¨ ×›××”. ×‘×¤×•×¢×œ ×›×•×œ× ×™×™×›× ×¡×• ×™×—×“ ×œ×©×“×” "××œ" ×›×“×™ ×œ×× ×•×¢ ×‘××’ ×©×œ Outlook.</div>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 sm:justify-end">
              <button id="bulkDeliverBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 w-full sm:w-auto">
                ×¡××Ÿ ×›× ××¡×¨ + ××™×™×œ ××¨×•×›×–
              </button>
            </div>
          </div>
        </div>
      ` : '';

      const tableRows = filtered.length === 0
        ? `<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">××™×Ÿ ×“×•×’×××•×ª ×œ×”×¦×’×”</td></tr>`
        : filtered.map(s => {
            const status = statusOptions.find(st => st.value === s.status) || statusOptions[0];
            const assigned = s.assignedTo ? (contacts.find(c => c.id === s.assignedTo)?.name || '×œ× ×™×“×•×¢') : '-';
            const checked = selectedSampleIds.has(s.id) ? 'checked' : '';
            return `
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <input type="checkbox" class="rowChk h-4 w-4" data-id="${escapeHtml(s.id)}" ${checked}>
                </td>
                <td class="px-6 py-4">
                  <div class="font-medium break-anywhere">${escapeHtml(s.name)}</div>
                  <div class="text-sm text-gray-400">#${Number(s.seq || 0)}</div>
                </td>
                <td class="px-6 py-4 break-anywhere">${escapeHtml(s.supplier)}</td>
                <td class="px-6 py-4 text-gray-600">${Number(s.quantity || 0)}</td>
                <td class="px-6 py-4 text-gray-600 whitespace-nowrap">${new Date(s.date).toLocaleDateString('he-IL')}</td>
                <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-sm ${status.color} whitespace-nowrap">${status.label}</span></td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs shrink-0">ğŸ‘¤</div>
                    <span class="text-sm break-anywhere">${escapeHtml(assigned)}</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center gap-3">
                    <button onclick="openSampleModal('${s.id}')" class="text-blue-600 hover:text-blue-800">×¢×¨×•×š</button>
                    <button onclick="deleteSample('${s.id}')" class="text-red-600 hover:text-red-800">××—×§</button>
                  </div>
                </td>
              </tr>`;
          }).join('');

      const emailLogHtml = emailLog.length > 0 ? `
        <div class="mt-6 bg-white rounded-xl border p-6">
          <div class="flex items-center justify-between mb-4 gap-3 flex-wrap">
            <div class="flex items-center gap-2">
              <i data-lucide="mail" class="w-5 h-5 text-gray-600"></i>
              <h3 class="text-lg font-bold">×™×•××Ÿ ××™×™×œ×™×</h3>
              <span class="text-sm text-gray-500">(${emailLog.length} × ×¨×©××•)</span>
            </div>
            <button onclick="clearEmailLog()" class="px-3 py-1 text-sm border rounded-lg hover:bg-gray-50">
              × ×§×” ×™×•××Ÿ
            </button>
          </div>

          <div class="space-y-2 max-h-60 overflow-y-auto">
            ${emailLog.slice(-8).reverse().map((e, idx) => `
              <div class="p-3 bg-gray-50 rounded-lg text-sm">
                <div class="flex justify-between mb-1 gap-3 items-start">
                  <div class="font-medium break-anywhere">${escapeHtml(e.subject || '')}</div>

                  <div class="flex items-center gap-3 whitespace-nowrap">
                    <span class="text-gray-500">${new Date(e.timestamp).toLocaleString('he-IL')}</span>
                    <button onclick="deleteEmailLogItem(${idx})"
                      class="text-red-600 hover:text-red-800 text-xs border border-red-200 rounded px-2 py-1">
                      ××—×§
                    </button>
                  </div>
                </div>

                <div class="text-gray-600 break-anywhere">× ××¢×Ÿ ×¨××©×™: ${escapeHtml(e.to || '')}</div>
                ${(Array.isArray(e.extra) && e.extra.length)
                  ? `<div class="text-gray-500 text-xs mt-1 break-anywhere">× ××¢× ×™× × ×•×¡×¤×™×: ${escapeHtml(e.extra.join(', '))}</div>`
                  : ``}
              </div>
            `).join('')}
          </div>

          <div class="text-xs text-gray-500 mt-3">* ×–×” ×™×•××Ÿ ×¡×™××•×œ×¦×™×”. ×©×œ×™×—×” ×××™×ª×™×ª ×“×•×¨×©×ª ×©×¨×ª/××•×˜×•××¦×™×”.</div>
        </div>` : '';

      document.getElementById('mainContent').innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <div class="min-w-0">
            <h2 class="text-2xl sm:text-3xl font-bold mb-1">× ×™×”×•×œ ×“×•×’×××•×ª</h2>
            <p class="text-gray-600">××¢×§×‘ ×•× ×™×”×•×œ ×“×•×’×××•×ª ×©×”×ª×§×‘×œ×• ×‘×—×‘×¨×”</p>
          </div>
          <button id="newSampleBtn" class="flex items-center justify-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 w-full sm:w-auto">
            <i data-lucide="plus" class="w-5 h-5"></i>
            ×“×•×’××” ×—×“×©×”
          </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 sm:gap-4 mb-6">
          <div class="bg-white p-4 sm:p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×¡×”"×›</span>
              <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center">
                <i data-lucide="package" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-2xl sm:text-3xl font-bold">${stats.total}</div>
          </div>

          <div class="bg-white p-4 sm:p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×”×•×–××Ÿ</span>
              <div class="w-10 h-10 bg-gray-700 rounded-lg flex items-center justify-center">
                <i data-lucide="shopping-cart" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-2xl sm:text-3xl font-bold">${stats.ordered}</div>
          </div>

          <div class="bg-white p-4 sm:p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×”×ª×§×‘×œ</span>
              <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                <i data-lucide="check-circle" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-2xl sm:text-3xl font-bold">${stats.received}</div>
          </div>

          <div class="bg-white p-4 sm:p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">×‘×‘×“×™×§×”</span>
              <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center">
                <i data-lucide="clock" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-2xl sm:text-3xl font-bold">${stats.testing}</div>
          </div>

          <div class="bg-white p-4 sm:p-6 rounded-xl border">
            <div class="flex justify-between mb-2">
              <span class="text-gray-600">× ××¡×¨</span>
              <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                <i data-lucide="send" class="w-5 h-5 text-white"></i>
              </div>
            </div>
            <div class="text-2xl sm:text-3xl font-bold">${stats.delivered}</div>
          </div>
        </div>

        <div class="bg-white rounded-xl border mb-6 p-4">
          <div class="flex flex-col sm:flex-row gap-4">
            <select id="statusFilter" class="px-4 py-2 border rounded-lg w-full sm:w-52">
              <option value="all" ${uiState.status === 'all' ? 'selected' : ''}>×›×œ ×”×¡×˜×˜×•×¡×™×</option>
              ${statusOptions.map(o => `<option value="${o.value}" ${uiState.status === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
            </select>

            <div class="flex-1 relative">
              <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
              <input id="searchInput" type="text" value="${escapeHtml(uiState.search)}" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×, ×¡×¤×§ ××• ××¡×¤×¨ ×“×•×’××”..." class="w-full pr-10 pl-4 py-2 border rounded-lg">
            </div>
          </div>
        </div>

        ${bulkBar}

        <div class="bg-white rounded-xl border overflow-hidden">
          <div class="table-scroll">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700 w-10">
                    <input id="selectAllChk" type="checkbox" class="h-4 w-4">
                  </th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×©× ×”×“×•×’××”</th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×¡×¤×§</th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×›××•×ª</th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×ª××¨×™×š</th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×¡×˜×˜×•×¡</th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">× ××¡×¨ ×œ</th>
                  <th class="px-6 py-3 text-right text-sm font-medium text-gray-700">×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody class="divide-y">${tableRows}</tbody>
            </table>
          </div>
        </div>

        ${emailLogHtml}
      `;

      lucide.createIcons();

      // âœ… ×××–×™× ×™× ×©××¢×“×›× ×™× state ×•××– ××¨× ×“×¨×™×
      document.getElementById('statusFilter')?.addEventListener('change', (e) => {
        uiState.status = e.target.value || 'all';
        renderMain();
      });

      document.getElementById('searchInput')?.addEventListener('input', (e) => {
        uiState.search = e.target.value || '';
        renderMain();
      });

      document.getElementById('newSampleBtn')?.addEventListener('click', () => openSampleModal());

      // ===========================
      // âœ… ×‘×—×™×¨×” ××¨×•×‘×” - ××™×¨×•×¢×™×
      // ===========================
      document.querySelectorAll('.rowChk').forEach(chk => {
        chk.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          if (!id) return;
          if (e.target.checked) selectedSampleIds.add(id);
          else selectedSampleIds.delete(id);
          renderMain();
        });
      });

      const selectAll = document.getElementById('selectAllChk');
      if (selectAll) {
        const visibleIds = filtered.map(x => x.id);
        const allSelected = visibleIds.length > 0 && visibleIds.every(id => selectedSampleIds.has(id));
        selectAll.checked = allSelected;

        selectAll.addEventListener('change', (e) => {
          if (e.target.checked) visibleIds.forEach(id => selectedSampleIds.add(id));
          else visibleIds.forEach(id => selectedSampleIds.delete(id));
          renderMain();
        });
      }

      const bulkClearBtn = document.getElementById('bulkClearBtn');
      if (bulkClearBtn) {
        bulkClearBtn.addEventListener('click', () => {
          selectedSampleIds.clear();
          renderMain();
        });
      }

      const bulkDeliverBtn = document.getElementById('bulkDeliverBtn');
      if (bulkDeliverBtn) {
        bulkDeliverBtn.addEventListener('click', async () => {
          const assignedToId = document.getElementById('bulkAssignedTo')?.value || "";
          const emailMain = document.getElementById('bulkEmailMain')?.value || "";

          const ccSel = document.getElementById('bulkEmailCc');
          const emailCcList = ccSel ? Array.from(ccSel.selectedOptions).map(o => (o.value || '').trim()).filter(Boolean) : [];

          await bulkDeliverAndEmail({
            ids: Array.from(selectedSampleIds),
            assignedToId,
            emailMain,
            emailCcList
          });
        });
      }
    }

    // ==========================================
    // Sample Modal + ×ª××¨×™×š
    // ==========================================
    function toDateInputValue(isoOrDate) {
      const d = isoOrDate ? new Date(isoOrDate) : new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function openSampleModal(id = null) {
      currentSample = id ? samples.find(s => s.id === id) : null;
      document.getElementById('sampleModalTitle').textContent = currentSample ? '×¢×¨×™×›×ª ×“×•×’××”' : '×“×•×’××” ×—×“×©×”';

      const contactOptions = contacts.map(c =>
        `<option value="${escapeHtml(c.email)}" ${currentSample?.notifyEmail === c.email ? 'selected' : ''}>${escapeHtml(c.name)} - ${escapeHtml(c.email)}</option>`
      ).join('');

      const assignedOptions = contacts.map(c =>
        `<option value="${escapeHtml(c.id)}" ${currentSample?.assignedTo === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>`
      ).join('');

      const selectedLower = new Set((currentSample?.ccEmails || []).map(e => (e || '').toLowerCase()));
      const ccOptions = contacts.map(c => {
        const sel = selectedLower.has((c.email || '').toLowerCase()) ? 'selected' : '';
        return `<option value="${escapeHtml(c.email)}" ${sel}>${escapeHtml(c.name)} - ${escapeHtml(c.email)}</option>`;
      }).join('');

      const dateValue = toDateInputValue(currentSample?.date || new Date());

      document.getElementById('sampleFormContent').innerHTML = `
        ${currentSample ? `<div class="text-xs text-gray-500">××¡×¤×¨ ×“×•×’××”: <b>#${Number(currentSample.seq || 0)}</b></div>` : ``}

        <div>
          <label class="block text-sm font-medium mb-2">×©× ×”×“×•×’××”</label>
          <input id="sampleName" type="text" value="${escapeHtml(currentSample?.name || '')}" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×¡×¤×§</label>
          <input id="sampleSupplier" type="text" value="${escapeHtml(currentSample?.supplier || '')}" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×›××•×ª</label>
          <input id="sampleQuantity" type="number" min="0" value="${Number(currentSample?.quantity || 0)}" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×ª××¨×™×š</label>
          <input id="sampleDate" type="date" value="${dateValue}" class="w-full px-4 py-2 border rounded-lg">
          <div class="text-xs text-gray-500 mt-1">×œ× ×—×•×‘×”. ××¤×©×¨ ×œ×”×©××™×¨ ×¨×™×§ ×‘×¡×˜×˜×•×¡ "×”×•×–××Ÿ".</div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×¡×˜×˜×•×¡</label>
          <select id="sampleStatus" class="w-full px-4 py-2 border rounded-lg">
            ${statusOptions.map(o => `<option value="${o.value}" ${(currentSample?.status === o.value) || (!currentSample && o.value === 'ordered') ? 'selected' : ''}>${o.label}</option>`).join('')}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">×”×•×“×¢×” ×œ××™×™×œ (× ××¢×Ÿ ×¨××©×™)</label>
          <select id="sampleNotifyEmail" class="w-full px-4 py-2 border rounded-lg">
            <option value="">-- ×‘×—×¨ ××™×© ×§×©×¨ --</option>
            ${contactOptions}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">× ××¢× ×™× × ×•×¡×¤×™× (×œ×‘×—×™×¨×” ××ª×•×š ×× ×©×™ ×”×§×©×¨)</label>
          <select id="sampleCcEmails" multiple class="w-full px-4 py-2 border rounded-lg h-28">
            ${ccOptions}
          </select>
          <div class="text-xs text-gray-500 mt-1">××¤×©×¨ ×œ×‘×—×•×¨ ×›××” (Ctrl/Shift). ×‘×¤×•×¢×œ ×”× ×™×™×›× ×¡×• ×™×—×“ ×œ×©×“×” "××œ" ×›×“×™ ×œ×× ×•×¢ ×‘××’ ×©×œ Outlook.</div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">× ××¡×¨ ×œ</label>
          <select id="sampleAssigned" class="w-full px-4 py-2 border rounded-lg">
            <option value="">-- ×‘×—×¨ ××™×© ×§×©×¨ --</option>
            ${assignedOptions}
          </select>
          <div class="text-xs text-gray-500 mt-1">×›×©×¡×˜×˜×•×¡ "× ××¡×¨" ×—×•×‘×” ×œ×‘×—×•×¨ ×œ××™ × ××¡×¨.</div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row justify-end gap-3">
          <button onclick="closeModal('sampleModal')" class="px-4 py-2 border rounded-lg w-full sm:w-auto">×‘×˜×œ</button>
          <button onclick="saveSample()" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 w-full sm:w-auto">×©××•×¨</button>
        </div>
      `;

      document.getElementById('sampleModal').classList.remove('hidden');
      document.getElementById('sampleModal').classList.add('flex');
      lucide.createIcons();
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      document.getElementById(modalId).classList.remove('flex');
      currentSample = null;
      editingContact = null;
    }

    async function saveSample() {
      const name = document.getElementById('sampleName').value.trim();
      const supplier = document.getElementById('sampleSupplier').value.trim();
      const quantity = parseInt(document.getElementById('sampleQuantity').value, 10) || 0;
      const status = document.getElementById('sampleStatus').value;
      const notifyEmail = document.getElementById('sampleNotifyEmail').value;
      const assignedTo = document.getElementById('sampleAssigned').value || null;

      const ccSel = document.getElementById('sampleCcEmails');
      const ccEmails = ccSel ? Array.from(ccSel.selectedOptions).map(o => (o.value || '').trim()).filter(Boolean) : [];

      const dateInput = document.getElementById('sampleDate')?.value; // YYYY-MM-DD
      const dateIso = dateInput ? new Date(dateInput + "T12:00:00").toISOString() : new Date().toISOString();

      if (!name) return alert('×™×© ×œ×”×–×™×Ÿ ×©× ×“×•×’××”');
      if (status === 'delivered' && !assignedTo) {
        return alert('×›×©×¡×˜×˜×•×¡ "× ××¡×¨" ×—×•×‘×” ×œ×‘×—×•×¨ ×œ××™ × ××¡×¨ ×”×¤×¨×™×˜.');
      }

      const oldStatus = currentSample?.status || null;

      if (currentSample) {
        Object.assign(currentSample, { name, supplier, quantity, status, notifyEmail, ccEmails, assignedTo, date: dateIso });
      } else {
        const id = generateId("SMPL");
        const seq = nextSampleSeq();
        samples.push({ id, seq, name, supplier, quantity, status, notifyEmail, ccEmails, assignedTo, date: dateIso });
      }

      const saved = await saveData();

      if (saved && status !== oldStatus && status !== 'ordered') {
        const sampleRef = currentSample || samples[samples.length - 1];
        sendEmail(sampleRef, oldStatus, status);
        await saveData();
      }

      closeModal('sampleModal');
      renderMain();
    }

    async function deleteSample(id) {
      if (!confirm("×œ××—×•×§ ×“×•×’××” ×–×•?")) return;
      samples = samples.filter(s => s.id !== id);
      if (selectedSampleIds.has(id)) selectedSampleIds.delete(id);
      await saveData();
      renderMain();
    }

    // ==========================================
    // Contacts
    // ==========================================
    function openContactsModal() {
      renderContacts();
      document.getElementById('contactsModal').classList.remove('hidden');
      document.getElementById('contactsModal').classList.add('flex');
      lucide.createIcons();
    }

    function renderContacts() {
      document.getElementById('contactsCount').textContent = contacts.length;

      const section = document.getElementById('contactsListSection');
      section.innerHTML = contacts.length === 0
        ? `<div class="text-gray-500 text-center py-4">××™×Ÿ ×× ×©×™ ×§×©×¨. ×œ×—×¥ ×¢×œ "×”×•×¡×£ ××™×© ×§×©×¨" ×›×“×™ ×œ×”×ª×—×™×œ.</div>`
        : contacts.map(c => `
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 bg-gray-50 p-3 rounded-lg">
            <div class="min-w-0">
              <span class="font-medium break-anywhere">${escapeHtml(c.name)}</span>
              <span class="text-gray-400">â€¢</span>
              <span class="text-gray-600 break-anywhere">${escapeHtml(c.email)}</span>
            </div>
            <div class="flex gap-2 shrink-0">
              <button onclick="editContact('${escapeHtml(c.id)}')" class="text-blue-600 hover:text-blue-800 px-3 py-1">×¢×¨×•×š</button>
              <button onclick="deleteContact('${escapeHtml(c.id)}')" class="text-red-600 hover:text-red-800 px-3 py-1">××—×§</button>
            </div>
          </div>
        `).join('');

      document.getElementById('addContactBtn').onclick = () => showContactForm();
    }

    function showContactForm(contactId = null) {
      editingContact = contactId ? contacts.find(c => c.id === contactId) : null;

      const section = document.getElementById('contactsFormSection');
      section.classList.remove('hidden');
      section.innerHTML = `
        <h4 class="font-bold mb-3">${editingContact ? '×¢×¨×™×›×ª ××™×© ×§×©×¨' : '××™×© ×§×©×¨ ×—×“×©'}</h4>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">×©× ××œ×</label>
            <input id="contactName" type="text" placeholder="×©× ×¤×¨×˜×™ ×•××©×¤×—×”" value="${escapeHtml(editingContact?.name || '')}" class="w-full px-4 py-2 border rounded-lg">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">×›×ª×•×‘×ª ××™×™×œ</label>
            <input id="contactEmail" type="email" placeholder="example@company.com" value="${escapeHtml(editingContact?.email || '')}" class="w-full px-4 py-2 border rounded-lg">
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row justify-end gap-3">
          <button onclick="clearContactForm()" class="px-4 py-2 border rounded-lg hover:bg-gray-50 w-full sm:w-auto">×‘×˜×œ</button>
          <button onclick="saveContact()" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 w-full sm:w-auto">×©××•×¨</button>
        </div>
      `;
    }

    function editContact(id) { showContactForm(id); }

    function clearContactForm() {
      editingContact = null;
      document.getElementById('contactsFormSection').classList.add('hidden');
      document.getElementById('contactsFormSection').innerHTML = '';
    }

    async function saveContact() {
      const name = document.getElementById('contactName')?.value.trim();
      const email = document.getElementById('contactEmail')?.value.trim();

      if (!name || !email) return alert('×™×© ×œ××œ× ×©× ×•××™×™×œ');
      if (!email.includes('@')) return alert('×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”');

      const emailLower = email.toLowerCase();
      const duplicate = contacts.find(c => c.email?.toLowerCase() === emailLower && (!editingContact || c.id !== editingContact.id));
      if (duplicate) return alert('×›×‘×¨ ×§×™×™× ××™×© ×§×©×¨ ×¢× ××™×™×œ ×–×”.');

      if (editingContact) Object.assign(editingContact, { name, email });
      else contacts.push({ id: generateId('C'), name, email });

      const saved = await saveData();
      if (saved) {
        clearContactForm();
        renderContacts();
        renderMain();
        alert('âœ… ××™×© ×”×§×©×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
      }
    }

    async function deleteContact(id) {
      if (!confirm("×œ××—×•×§ ××™×© ×§×©×¨ ×–×”?")) return;

      contacts = contacts.filter(c => c.id !== id);
      samples = samples.map(s => (s.assignedTo === id ? { ...s, assignedTo: null } : s));

      const saved = await saveData();
      if (saved) {
        renderContacts();
        renderMain();
        alert('âœ… ××™×© ×”×§×©×¨ × ××—×§ ×‘×”×¦×œ×—×”!');
      }
    }

    // ==========================================
    // Events + init
    // ==========================================
    document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
    document.getElementById('openContactsBtn').addEventListener('click', openContactsModal);
    document.getElementById('closeContactsModal').addEventListener('click', () => closeModal('contactsModal'));
    document.getElementById('closeSampleModal').addEventListener('click', () => closeModal('sampleModal'));

    document.getElementById('sampleModal').addEventListener('click', (e) => {
      if (e.target.id === "sampleModal") closeModal("sampleModal");
    });
    document.getElementById('contactsModal').addEventListener('click', (e) => {
      if (e.target.id === "contactsModal") closeModal("contactsModal");
    });

    const copyBtn = document.getElementById("copyRidBtn");
    if (copyBtn) {
      copyBtn.addEventListener("click", async () => {
        const rid = getRidFromUrl();
        if (!rid) return;
        try {
          await navigator.clipboard.writeText(rid);
          showBanner("âœ… ×”Ö¾Record ID ×”×•×¢×ª×§.", "ok");
        } catch {
          alert("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ××•×˜×•××˜×™×ª. ×”×¢×ª×§ ×™×“× ×™×ª ××”×©×•×¨×” ×œ××¢×œ×”.");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();
      updateRidUI(getRidFromUrl());
      updateDevicePill();
      window.addEventListener("resize", () => {
        updateDevicePill();
      }, { passive: true });

      loadData();
    });

    // ×—×©×™×¤×ª ×¤×•× ×§×¦×™×•×ª ×œ-onclick
    window.openSampleModal = openSampleModal;
    window.deleteSample = deleteSample;
    window.editContact = editContact;
    window.deleteContact = deleteContact;
    window.saveSample = saveSample;
    window.closeModal = closeModal;
    window.showContactForm = showContactForm;
    window.clearContactForm = clearContactForm;
    window.saveContact = saveContact;
    window.deleteEmailLogItem = deleteEmailLogItem;
    window.clearEmailLog = clearEmailLog;
  </script>

</body>
</html>
